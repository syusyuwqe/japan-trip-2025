<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Zen - äº¬éƒ½å¤§é˜ª (ç§‹)</title>
    
    <!-- å¼•å…¥ React å’Œ Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥åœ–æ¨™åº« (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #FAFAF5; 
            --card-bg: #FFFFFF;
            --text-main: #4A3B32;
            --text-sub: #8C7B70;
            --accent-red: #C04829;
            --accent-gold: #D68C45;
            --accent-green: #7D8A58;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 100px;
            background-image: radial-gradient(#E8D5B5 1px, transparent 1px);
            background-size: 20px 20px;
            user-select: none;
            overscroll-behavior-y: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in { animation: fadeIn 0.2s ease-out; }
        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        @keyframes fall {
            0% { transform: translate(0, -10vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.8; }
            100% { transform: translate(var(--sway), 110vh) rotate(360deg); opacity: 0; }
        }

        .liquid-nav {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.05);
            border-radius: 24px 24px 0 0;
            z-index: 40; /* Nav z-index */
        }
        
        .modal-z { z-index: 100 !important; } /* Force modal above everything */

        .highlight-eat { color: #C04829; background: #FFF0EB; padding: 2px 8px; border-radius: 6px; font-weight: bold; border: 1px solid #FFD1C1; display: inline-flex; align-items: center; gap: 4px; }
        .highlight-buy { color: #D68C45; background: #FFF8EB; padding: 2px 8px; border-radius: 6px; font-weight: bold; border: 1px solid #FFE8C1; display: inline-flex; align-items: center; gap: 4px; }
        .highlight-res { color: #7D8A58; background: #F2F5EB; padding: 2px 8px; border-radius: 6px; font-weight: bold; border: 1px solid #E1E8D1; display: inline-flex; align-items: center; gap: 4px; }

        .swipe-wrapper { position: relative; margin-bottom: 12px; border-radius: 16px; overflow: hidden; transform: translate3d(0,0,0); background-color: #ef4444; }
        .swipe-background { position: absolute; top: 0; bottom: 0; right: 0; width: 80px; display: flex; align-items: center; justify-content: center; z-index: 1; }
        .swipe-foreground { position: relative; z-index: 10; background: white; border-radius: 16px; border: 1px solid rgba(232, 213, 181, 0.5); box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); width: 100%; }

        .spinner { width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- GEMINI API SETUP ---
        const getApiKey = () => localStorage.getItem('gemini_api_key') || "";

        const callGemini = async (prompt) => {
            const key = getApiKey();
            if (!key) throw new Error("NO_KEY");

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        };

        // --- DATA & UTILS ---
        const EXCHANGE_RATE = 0.215;
        const DATES = [
            { date: '11/28', day: 'é€±å››', weather: 'sunny', temp: '12Â°' },
            { date: '11/29', day: 'é€±äº”', weather: 'cloudy', temp: '11Â°' },
            { date: '11/30', day: 'é€±å…­', weather: 'sunny', temp: '13Â°' },
            { date: '12/01', day: 'é€±æ—¥', weather: 'rain', temp: '9Â°' },
            { date: '12/02', day: 'é€±ä¸€', weather: 'cloudy', temp: '10Â°' },
            { date: '12/03', day: 'é€±äºŒ', weather: 'sunny', temp: '11Â°' },
            { date: '12/04', day: 'é€±ä¸‰', weather: 'sunny', temp: '12Â°' },
        ];

        const CAT_COLORS = {
            'é£Ÿ': { bg: '#FFF0EB', text: '#C04829', border: '#FFD1C1' },
            'è¡£': { bg: '#F0F9FF', text: '#0369A1', border: '#BAE6FD' },
            'ä½': { bg: '#F0FDF4', text: '#15803D', border: '#BBF7D0' },
            'è¡Œ': { bg: '#FAF5FF', text: '#7E22CE', border: '#E9D5FF' },
            'æ¨‚': { bg: '#FFF7ED', text: '#EA580C', border: '#FFEDD5' },
            'è²·': { bg: '#FFF1F2', text: '#BE123C', border: '#FECDD3' }
        };

        const getDefaultDate = () => {
            const today = new Date();
            const m = today.getMonth() + 1;
            const d = today.getDate();
            const dateStr = `${m}/${d}`;
            const exists = DATES.find(d => d.date === dateStr);
            return exists ? dateStr : '11/28';
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current) {
                    ref.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    ref.current.appendChild(i);
                    lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className } });
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        const SmartText = ({ text }) => {
            if (!text) return null;
            const parts = text.split(/(å¿…åƒ|å¿…è²·|å¿…é»|é ç´„ä»£è™Ÿ|é‡è¦)/g);
            return (
                <span className="leading-relaxed text-[#4A3B32] text-sm whitespace-pre-wrap">
                    {parts.map((part, index) => {
                        if (part === 'å¿…åƒ' || part === 'å¿…é»') return <span key={index} className="highlight-eat mx-1"><Icon name="utensils" size={12} /> {part}</span>;
                        if (part === 'å¿…è²·') return <span key={index} className="highlight-buy mx-1"><Icon name="shopping-bag" size={12} /> {part}</span>;
                        if (part.includes('é ç´„') || part === 'é‡è¦') return <span key={index} className="highlight-res mx-1"><Icon name="circle-alert" size={12} /> {part}</span>;
                        return part;
                    })}
                </span>
            );
        };

        // --- Falling Leaves Effect ---
        const FallingLeaves = () => {
            const leaves = useMemo(() => Array.from({ length: 15 }).map((_, i) => ({
                id: i,
                left: Math.random() * 100,
                delay: Math.random() * 10,
                duration: 10 + Math.random() * 10,
                size: 15 + Math.random() * 15,
                sway: Math.random() * 100 - 50,
                color: Math.random() > 0.6 ? '#C04829' : (Math.random() > 0.4 ? '#D68C45' : '#A4B494')
            })), []);

            return (
                <div className="fixed inset-0 pointer-events-none z-0 overflow-hidden" aria-hidden="true">
                    {leaves.map(leaf => (
                        <div key={leaf.id} style={{ position: 'absolute', top: '-50px', left: `${leaf.left}%`, width: `${leaf.size}px`, height: `${leaf.size}px`, color: leaf.color, opacity: 0, animation: `fall ${leaf.duration}s linear infinite`, animationDelay: `-${leaf.delay}s`, '--sway': `${leaf.sway}px` }}>
                            <svg viewBox="0 0 24 24" fill="currentColor" className="w-full h-full drop-shadow-sm"><path d="M12.96 6.04c.63-.4 1.42-.7 1.42-.7s-.25 1.38-.1 2.13c.9-.2 2.28-.7 2.28-.7s-1 1.7-1.1 2.3c.83.1 2.4.3 2.4.3s-1.6 1.2-2 1.6c.4.9 1.3 2.2 1.3 2.2s-1.8-.6-2.6-1.2c-.2.7-.1 1.9-.1 1.9l-1.7-1.2c-.1 1.2-.1 2.7-.1 2.7h-1.2s0-1.5-.1-2.7l-1.7 1.2s.1-1.2-.1-1.9c-.8.6-2.6 1.2-2.6 1.2s.9-1.3 1.3-2.2c-.4-.4-2-1.6-2-1.6s1.57-.2 2.4-.3c-.1-.6-1.1-2.3-1.1-2.3s1.38.5 2.28.7c.15-.75-.1-2.13-.1-2.13s.79.3 1.42.7L12 2l.96 4.04z"/></svg>
                        </div>
                    ))}
                </div>
            );
        };

        // --- Fixed Image Uploader ---
        const ImageUploader = ({ currentImage, onImageChange, label = "é»æ“Šæ›´æ›åœ–ç‰‡", height="h-32" }) => {
            const fileInputRef = useRef(null);
            const [showMenu, setShowMenu] = useState(false);
            const [showUrlInput, setShowUrlInput] = useState(false);
            const [urlInput, setUrlInput] = useState('');
            const [loadError, setLoadError] = useState(false);

            useEffect(() => { setLoadError(false); }, [currentImage]);
            
            const handleFile = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => { onImageChange(reader.result); setShowMenu(false); };
                    reader.readAsDataURL(file);
                }
            };

            const handleUrlSubmit = () => {
                if (urlInput) { onImageChange(urlInput); setShowUrlInput(false); setShowMenu(false); setUrlInput(''); }
            };

            return (
                <div className={`relative w-full ${height} bg-gray-100 rounded-xl overflow-hidden border-2 border-dashed border-[#D68C45]/30 shrink-0 group`}>
                    {currentImage && !loadError ? (
                        <img src={currentImage} className="w-full h-full object-cover" onError={() => setLoadError(true)} alt="Uploaded" />
                    ) : (
                        <div className="absolute inset-0 flex flex-col items-center justify-center text-[#8C7B70] pointer-events-none">
                            <Icon name={loadError ? "image-off" : "image-plus"} size={24} />
                            <span className="text-xs mt-2">{loadError ? "åœ–ç‰‡å¤±æ•ˆ" : label}</span>
                        </div>
                    )}
                    
                    <button onClick={(e) => { e.stopPropagation(); setShowMenu(true); }} className="absolute bottom-2 right-2 bg-white/90 text-[#4A3B32] p-2 rounded-lg shadow-md flex items-center gap-1 text-xs font-bold z-10 active:bg-gray-200"><Icon name="camera" size={14} /> ç·¨è¼¯</button>

                    {showMenu && (
                        <div className="absolute inset-0 bg-black/60 z-20 flex flex-col items-center justify-center gap-3 fade-in" onClick={(e) => { e.stopPropagation(); if(!showUrlInput) setShowMenu(false); }}>
                            {!showUrlInput ? (
                                <>
                                    <button onClick={(e) => { e.stopPropagation(); setShowUrlInput(true); }} className="bg-white w-32 py-2 rounded-xl font-bold text-[#4A3B32] shadow-lg transform active:scale-95 transition-transform">è²¼ä¸Šç¶²å€ ğŸ”—</button>
                                    <button onClick={(e) => { e.stopPropagation(); fileInputRef.current.click(); }} className="bg-white w-32 py-2 rounded-xl font-bold text-[#4A3B32] shadow-lg transform active:scale-95 transition-transform">ä¸Šå‚³æª”æ¡ˆ ğŸ“‚</button>
                                    <button onClick={(e) => { e.stopPropagation(); setShowMenu(false); }} className="text-white text-sm mt-2 underline">å–æ¶ˆ</button>
                                </>
                            ) : (
                                <div className="w-4/5 bg-white p-3 rounded-xl shadow-lg" onClick={e => e.stopPropagation()}>
                                    <label className="text-xs text-gray-500 mb-1 block">è¼¸å…¥åœ–ç‰‡ç¶²å€ï¼š</label>
                                    <input autoFocus value={urlInput} onChange={e => setUrlInput(e.target.value)} className="w-full p-2 border rounded mb-2 text-sm outline-none border-gray-300" placeholder="https://..." />
                                    <div className="flex gap-2"><button onClick={() => setShowUrlInput(false)} className="flex-1 py-1 text-xs text-gray-500">è¿”å›</button><button onClick={handleUrlSubmit} className="flex-1 py-1 bg-[#C04829] text-white rounded text-xs font-bold">ç¢ºèª</button></div>
                                </div>
                            )}
                        </div>
                    )}
                    <input type="file" ref={fileInputRef} onChange={handleFile} accept="image/*" className="hidden" />
                </div>
            );
        };

        // --- Customizable Swipe Item ---
        const SwipeItem = ({ children, onAction, link, label="åˆªé™¤", icon="trash-2", color="#ef4444" }) => {
            const [offset, setOffset] = useState(0);
            const startX = useRef(null);
            const currentOffset = useRef(0);
            const handleTouchStart = (e) => { startX.current = e.touches[0].clientX; };
            const handleTouchMove = (e) => {
                if (startX.current === null) return;
                const currentX = e.touches[0].clientX;
                const diff = currentX - startX.current;
                if (diff < 0) currentOffset.current = Math.max(diff, -100);
                else if (diff > 0 && offset < 0) currentOffset.current = Math.min(0, offset + diff);
                e.currentTarget.style.transform = `translateX(${currentOffset.current}px)`;
            };
            const handleTouchEnd = () => {
                if (currentOffset.current < -50) { setOffset(-80); e.currentTarget.style.transform = `translateX(-80px)`; } 
                else { setOffset(0); e.currentTarget.style.transform = `translateX(0px)`; }
                startX.current = null; currentOffset.current = offset;
            };
            
            const renderBackground = () => {
                if (link) {
                    return (
                        <a href={link} target="_blank" rel="noopener noreferrer" className="flex flex-col items-center justify-center text-white w-full h-full" onClick={(e) => e.stopPropagation()}>
                            <Icon name={icon} size={24} />
                            <span className="text-xs font-bold mt-1">{label}</span>
                        </a>
                    );
                }
                return (
                    <div className="flex flex-col items-center justify-center text-white w-full h-full" onClick={(e) => { e.stopPropagation(); onAction(e); setOffset(0); }}>
                        <Icon name={icon} size={24} />
                        <span className="text-xs font-bold mt-1">{label}</span>
                    </div>
                );
            };

            return (
                <div className="swipe-wrapper" style={{ backgroundColor: color }}>
                    <div className="swipe-background">{renderBackground()}</div>
                    <div className="swipe-foreground" style={{ transform: `translateX(${offset}px)` }} onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={handleTouchEnd}>
                        {children}
                        {offset === -80 && <div className="absolute inset-0 z-20" onClick={(e) => {e.stopPropagation(); setOffset(0); e.currentTarget.parentElement.style.transform = 'translateX(0px)';}}></div>}
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            
            // --- DATA (Updated V23 with user provided data) ---
            const [itinerary, setItinerary] = useState(() => JSON.parse(localStorage.getItem('itinerary_v23')) || {
                "11/28":[{"id":1,"time":"14:40","place":"æ­ä¹˜ç­æ©Ÿ IT 212","desc":"æ™‚é–“:1440-1755ã€‚\nè¨˜å¾—ä¸è¦å»¶èª¤ç­æ©Ÿå–”~","image":"https://static.tigerairtw.com/www/events/TTW10anniversary/images/kv_airplane.png","owner":"common","mapUrl":"https://maps.app.goo.gl/w7cmbhnue9GKehcx6"},{"id":2,"time":"18:30","place":"å¤§é˜ª Check in","desc":"é è¨ˆå‡ºé—œæ™‚é–“â†’ 18:30ï¼ŒæŠµé”å¸‚å€ (19:30)ã€‚","image":"https://www.bring-you.info/imgs/2017/12/shin-osaka-40.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/EbFzvx4KZZv8CtVW9"},{"id":3,"time":"21:00","place":"æ™šé¤ ç„¼è‚‰ éº“ã®å®®","desc":"å¿…åƒç‡’è‚‰ï¼","image":"https://tw.tabiiro.travel/lpimg/gourmet/314114/main/img5.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/WhhLHMjSBLjfDkX9A"},{"id":4,"time":"22:30","place":"å¿ƒé½‹æ©‹é€›è¡—","desc":"è—¥å¦ã€é›¶é£Ÿæ¡è²·ã€‚","image":"https://cdn.zekkei-japan.jp/images/areas/8bb3598e86006c8a2a283f36e14a0650.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/L83oHjpVYEQrrs3H6"}],
                "11/29":[{"id":11,"time":"09:00","place":"ä¸‹é´¨ç¥ç¤¾","desc":"# ã€ä¸–ç•Œéºç”¢ãƒ»äº¬éƒ½å¤è€ç¥åŸŸã€‘","image":"https://letsgokyoto.com/wp-content/uploads/2023/09/%E6%B2%B3%E5%90%88%E7%A5%9E%E7%A4%BE%EF%BC%88kyo_na_deer_%EF%BC%89.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/HA51ScyHsCgKGiXq5"},{"id":12,"time":"12:00","place":"åˆé¤ è‘±å±‹ã«ã‚‡ã‚åŠ©","desc":"å…ˆæ–—ç”ºåº—ã€‚","image":"https://img.lavietaste.com/rcmd/1c2f94ac56e5104b81443e151ffb518d_s.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/mVBTWfjbDRXeM1BF6"},{"id":13,"time":"10:30","place":"å¹³ç­‰å¯º","desc":"å› å¹¡å ‚ã€‚ï¼ˆå¦‚æœæœ‰æ™‚é–“å¯ä»¥å…ˆå»ï¼‰","image":"https://hk.wamazing.com/media/wp-content/uploads/sites/5/2023/08/byodoin_AU-1-eyecatch.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/mgPc3Xy3E4QzcDBx8"},{"id":14,"time":"16:00","place":"ä¼è¦‹ç¨»è·ç¥ç¤¾","desc":"åƒæœ¬é³¥å±…ã€‚ï¼ˆæœ‰æ™‚é–“å†å»ï¼‰","image":"https://unicorntw.com/wp-content/uploads/2014/12/167.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/sWf8mU27Qzu9csP18"},{"id":15,"time":"13:00","place":"æ¸…æ°´å¯º &äºŒä¸‰å¹´ç‰ˆ","desc":"å¤•é™½ã€‚","image":"https://mediaim.expedia.com/destination/1/3bc76a96d16aed5e1f00c3a30a815b11.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/Km5ia96RRxGhY9Ab7"},{"id":16,"time":"20:00","place":"æ¢…ç”°","desc":"æ™šé¤orè³¼ç‰©","image":"https://tw.wamazing.com/media/wp-content/uploads/sites/4/2024/10/762_osakaumeda_pixta_76974546_M-853x569.jpg","owner":"common","mapUrl":""},{"id":1764199968519,"time":"20:00","place":"å¤©ç‹å¯ºå…¬åœ’å¸‚é›†","desc":"è–èª•å¸‚é›† in å¤§é˜ª TEN-SHIBA","image":"https://www.fashion-press.net/img/news/138827/Kr8.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/rpt4wdHo3wE7zxDC8"}],
                "11/30":[{"id":21,"time":"10:00","place":"ä¸­å¤å ‚éº»ç³¬","desc":"ç¾æ—éº»ç³¬ã€‚\nå˜¿~å‘€~å˜¿~å‘€","image":"https://rimage.gnst.jp/livejapan.com/public/article/detail/a/20/00/a2000330/img/zh-tw/a2000330_parts_5e281d9d46037.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/eUMNTqgNj18UJTZU8"},{"id":22,"time":"11:00","place":"å¥ˆè‰¯å…¬åœ’","desc":"èˆ‡é¹¿é¹¿ç¸½è£é–‹æœƒ","image":"https://image.cdn-eztravel.com.tw/ijXlVR4ERQEZFzDJncxZBhR_3oD2wcH-zpV0Eeidwgs/g:ce/aHR0cHM6Ly92YWNhdGlvbi5jZG4tZXp0cmF2ZWwuY29tLnR3L2ltZy9WRFIvSlBfMTU4OTc5MDA1Mi5qcGc.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/XUN6Z67VyEHDzY3L7"},{"id":23,"time":"13:00","place":"æ°´è°·èŒ¶å±‹","desc":"èŒ¶å±‹ã€‚\nä¼‘æ¯å°æ†©","image":"https://tenjo.tw/wp-content/uploads/collage-67.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/HhwGP765VVh9iZUi6"},{"id":24,"time":"13:30","place":"æ˜¥æ—¥å¤§ç¤¾","desc":"æœ¬æ®¿ï¼ˆç¦¦æ­£æ®¿ï¼‰->å…è²»åƒè§€\nåœ‹å¯¶æ®¿ -> 500 æ—¥åœ“\nç´«è—¤èŠ±åœ’ -> 500 æ—¥åœ“","image":"https://tw.wamazing.com/media/wp-content/uploads/sites/4/2023/11/kasugataisha_eyecatch_pixta_95372544_M.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/Z1Bikje7FYqoYPTP7"},{"id":25,"time":"16:00","place":"ç”Ÿé§’å±±ä¸ŠéŠæ¨‚åœ’","desc":"å‚æ™šå»çœ‹å¤•é™½å°±å¥½ã€‚","image":"https://res.klook.com/image/upload/c_crop,h_800,w_1280,x_0,y_10,z_0.5/w_750,h_469,c_fill,q_85/w_80,x_15,y_15,g_south_west,l_Klook_water_br_trans_yhcmh3/activities/b5t01dn87japgrpyvnil.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/wfvy914kGv8iK7KY7"},{"id":1764199753036,"time":"20:00","place":"æ—¥æœ¬æ©‹ã€é›£æ³¢é€›è¡—","desc":"å°±æ˜¯åˆ°è™•è·‘è·‘ï¼Œå®…æ³¡èšé›†åœ°","image":"https://wp-odai.wamazing.com/media/wp-content/uploads/sites/2/2025/01/osakanipponbashi_pixta_92154927_M.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/6tmxkscPyFku3j8H7"}],
                "12/01":[{"id":1764199780893,"time":"08:00","place":"æ¡è³¼","desc":"é»æ“Šç·¨è¼¯è©³æƒ…","image":"","owner":"common","mapUrl":""},{"id":1764199865385,"time":"10:00","place":"ç¾åœ‹æ‘","desc":"é€™è£¡å¯ä»¥å¤è‘—æŒ–å¯¶","image":"https://www.e-japannavi.com/syuyu/osaka/images/shinsaibashi_america_img700465_05.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/KoRVnsMkYcb1Y6Kp7"},{"id":1764199876034,"time":"13:00","place":"æ¢…ç”°","desc":"é»æ“Šç·¨è¼¯è©³æƒ…","image":"","owner":"common","mapUrl":""},{"id":1764199906578,"time":"08:30","place":"æœ¨æ´¥å¸‚å ´","desc":"é€™è£¡çš„ç”Ÿé­šç‰‡æ–°é®®çš„","image":"https://i0.wp.com/poliluvtravel.com/wp-content/uploads/2020/03/kizu-ichiba_1_IMG_3650.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/yVW8Fx8GGSZEaUMx7"},{"id":1764229893864,"time":"00:00","place":"Kirby CafÃ© Osaka","desc":"æœ‰å–¬åˆ°ä½ç½®å°±å»\n","image":"https://kirbycafe.jp/cafe/osaka/imgs/img-shop-visual.jpg","owner":"common","mapUrl":""},{"id":1764231413366,"time":"14:00","place":"goldy-éŠ€é£¾","desc":"","image":"https://goldy.jp/wp-content/uploads/2022/09/c64f358b8ba1ae634160b5c2b2768b72-1024x683.jpg","owner":"common","mapUrl":"https://maps.app.goo.gl/P7Cor7Afkx2qrn6L7"}],
                "12/02":[{"id":1764200004798,"time":"07:00","place":"æ—©é¤","desc":"æ‰¾é–“æ—¥å¼é£¯ç³°ä¾†åƒ","image":"","owner":"xu","mapUrl":""},{"id":1764200022185,"time":"10:00","place":"è‡¨ç©ºåŸoutlet","desc":"ç¨å¾®é€›ä¸€ä¸‹æœ‰æ²’æœ‰æ¼è²·çš„","image":"https://rinkunoyu.jp/wp/wp-content/uploads/2023/09/593bcc8186aa98657c5346a8a4748ae8.jpg","owner":"xu","mapUrl":"https://maps.app.goo.gl/EjKi9zMoDumxDWjCA"},{"id":1764200046566,"time":"13:00","place":"æ©Ÿå ´check in","desc":"å…ˆå»å ±åˆ°æ¢æ¢è·¯ï¼Œé †ä¾¿åœ¨æ©Ÿå ´ç†Ÿæ‚‰è·¯ç·š","image":"https://www.kansai-airport.or.jp/static/images/map/index-01_tw.png","owner":"xu","mapUrl":"https://maps.app.goo.gl/yqHyhAZE5QDLKveS8"},{"id":1764200064927,"time":"15:25","place":"é—œè¥¿æ©Ÿå ´T2","desc":"èµ·é£›ï½æ‹œæ‹œå¤§é˜ª","image":"https://static.tigerairtw.com/www/events/TTW10anniversary/images/kv_airplane.png","owner":"xu","mapUrl":""},{"id":1764200290509,"time":"09:00","place":"å‹å°¾å¯º","desc":"","image":"https://res.klook.com/image/upload/w_750,h_469,c_fill,q_85/w_80,x_15,y_15,g_south_west,l_Klook_water_br_trans_yhcmh3/activities/mmnqsbcymiztuwzrvyml.jpg","owner":"zhen","mapUrl":"https://maps.app.goo.gl/GAfzAbfFDmv7HHe39"},{"id":1764200316620,"time":"00:00","place":"æ¢…ç”°","desc":"é»æ“Šç·¨è¼¯è©³æƒ…","image":"","owner":"zhen","mapUrl":""},{"id":1764200338780,"time":"13:00","place":"æ‰­è›‹ä¹‹æ£®","desc":"é»æ“Šç·¨è¼¯è©³æƒ…","image":"https://content.fun-japan.jp/renewal-prod/cms/articles/content/A02l-9IMG9140jpg_2022-07-15-12-54-08.jpg","owner":"zhen","mapUrl":"https://maps.app.goo.gl/ycto7QsZ4QWMyPtCA"},{"id":1764200380320,"time":"15:00","place":"æ¢…ç”°èŒ¶å±‹ç”ºåº—","desc":"æ‡‰è©²æœ‰ä¸‹åˆèŒ¶å§","image":"https://47life.tw/wp-content/uploads/2019/11/20241007-vfehq.jpg","owner":"zhen","mapUrl":"https://maps.app.goo.gl/C44whEoqpKMqnaXKA"},{"id":1764200429973,"time":"17:00","place":"æ¢…ç”°è—å¤©å¤§æ¨“","desc":"é»æ“Šç·¨è¼¯è©³æƒ…","image":"https://res.klook.com/images/fl_lossy.progressive,q_65/c_fill,w_1620,h_1080/w_80,x_15,y_15,g_south_west,l_Klook_water_br_trans_yhcmh3/activities/jiopyvnamz3tlbufhfsn/%E6%A2%85%E7%94%B0%E8%97%8D%E5%A4%A9%E5%A4%A7%E5%BB%88%E7%A9%BA%E4%B8%AD%E5%BA%AD%E5%9C%9B%E5%8F%B0%E9%96%80%E7%A5%A8-Klook%E5%AE%A2%E8%B7%AF.jpg","owner":"zhen","mapUrl":"https://maps.app.goo.gl/DcuKCZ4QKo9BPBKT9"}],
                "12/03":[{"id":1764200465273,"time":"06:00","place":"èµ·åºŠ","desc":"å¹¹æˆ‘ä¸€å®šçˆ¬ä¸èµ·ä¾†","image":"","owner":"xu","mapUrl":""},{"id":1764200502470,"time":"08:00","place":"é´»æµ·","desc":"ä¸€å®šæœƒè¢«æŠ˜ç£¨å¾—å¾ˆæ…˜","image":"","owner":"xu","mapUrl":""},{"id":1764200524246,"time":"17:30","place":"ä¸‹ç­","desc":"æœ€å¥½æ˜¯å›ä¾†ç¬¬ä¸€å¤©éƒ½æ²’äº‹è›¤","image":"","owner":"xu","mapUrl":""},{"id":1764200553290,"time":"20:00","place":"å»ç…§é¡§è¸è¸","desc":"é‚£éš»è²“ä¸€å®šæƒ³èªªç‚ºä»€éº¼æ¯å¤©éƒ½çœ‹å¾—åˆ°æˆ‘","image":"","owner":"xu","mapUrl":""},{"id":1764200587523,"time":"09:00","place":"ä¸‹é´¨ç¥ç¤¾","desc":"è£œè²·å¾¡å®ˆ å¾¡é¦¬","image":"https://img.cloudimg.in/uploads/shops/3806/products/ef/ef5b0852e76e7636f26ce91509840136.jpg","owner":"zhen","mapUrl":"https://maps.app.goo.gl/HA51ScyHsCgKGiXq5"},{"id":1764200620100,"time":"13:00","place":"éºµå±‹","desc":"è¦ç¾å ´æ’éšŠ","image":"","owner":"zhen","mapUrl":""}],"12/04":[{"id":1764200664002,"time":"08:00","place":"é´»æµ·","desc":"ä¸Šç­å•¦å¹¹","image":"","owner":"xu","mapUrl":""},{"id":1764200716751,"time":"09:00","place":"æ¢…ç”°","desc":"City Terminal by Plaza Premium å¯„æ”¾è¡Œæ","image":"","owner":"zhen","mapUrl":""},{"id":1764200741690,"time":"00:00","place":"Onigiri Gorichan","desc":"å¯ä»¥å»åƒ","image":"https://arne.media/uploads/2025/01/A3C87EE8-A354-4EEE-AC98-44B57359E03F-675x506.jpg","owner":"zhen","mapUrl":""},{"id":1764200789847,"time":"12:00","place":"é€›ç™¾è²¨","desc":"èª°çŸ¥é“ä½ å€‘é€›å“ªä¸€æ£Ÿ","image":"","owner":"zhen","mapUrl":""},{"id":1764200828569,"time":"15:20","place":"æ¢…ç”°","desc":"å›é ­æ‹¿è¡Œæï¼Œæº–å‚™è¶•é£›æ©Ÿ","image":"","owner":"zhen","mapUrl":""},{"id":1764200894083,"time":"19:55","place":"é—œè¥¿æ©Ÿå ´","desc":"æº–å‚™èµ·é£›ï¼Œå¤§é˜ªè¡ŒçµæŸ","image":"https://static.tigerairtw.com/www/events/TTW10anniversary/images/kv_airplane.png","owner":"zhen","mapUrl":""}]
            });
            const [checkInData, setCheckInData] = useState(() => JSON.parse(localStorage.getItem('checkin_v9')) || {
                xu: { depart: "è‡ºç£è™èˆª T212\n14:40 TPE å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´T1\n17:55 KIX é—œè¥¿åœ‹éš›æ©Ÿå ´ T1", departImg: "", back: "æ—¥æœ¬æ¨‚æ¡ƒèˆªç©º MM027\nèˆªç­è³‡è¨Š\n15:25,é—œè¥¿åœ‹éš›æ©Ÿå ´T2\n17:55,å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´1 T1", backImg: "https://photos.fife.usercontent.google.com/pw/AP1GczMnWzMYApLQWyqs9RfoeMQa0tpMQTftSHVxKphyYSuT4fZkpCnJEZN43Q=w964-h702-s-no-gm?authuser=0", hotel: "Sunshine Tower\nè¯¥é…’åº—å¯åœ¨å¹³æ¿ç”µè„‘ä¸Šè‡ªåŠ©å…¥ä½ã€‚\n\nåœ¨é…’åº—å¹³æ¿ç”µè„‘ä¸­è¾“å…¥ä¸Šé¢çš„ç­¾åˆ°ä»£ç ï¼Œç„¶åç­¾å…¥ã€‚", hotelImg: "" },
                zhen: { depart: "è‡ºç£è™èˆª T212\n14:40 TPE å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´T1\n17:55 KIX é—œè¥¿åœ‹éš›æ©Ÿå ´ T1", departImg: "", back: "è‡ºç£è™èˆª T212\n19:55 TPE å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´T1\n22:10 KIX é—œè¥¿åœ‹éš›æ©Ÿå ´ T1", backImg: "", hotel: "è‰¾æ€åˆ©å¾·é£¯åº— é›£æ³¢é“é “å €æ±\nã‚¨ã‚¹ãƒªãƒ¼ãƒ‰ãƒ›ãƒ†ãƒ«é›£æ³¢é“é “å €ã‚¤ãƒ¼ã‚¹ãƒˆ\n2025å¹´11æœˆ28æ—¥é€±äº”ä¸€12æœˆ4æ—¥é€±å››\n6æ™š\nå…¥ä½:16:00å¾Œ\né€€æˆ¿:10:00å‰", hotelImg: "" }
            });
            const [phrases, setPhrases] = useState(() => JSON.parse(localStorage.getItem('phrases_v9')) || [
                {id: 1, jp: "ã“ã‚Œã„ãã‚‰ã§ã™ã‹ï¼Ÿ", zh: "é€™å€‹å¤šå°‘éŒ¢ï¼Ÿ", romaji: "Kore ikura desuka?", note: "è‹¦å‹’ ä»¥å“­æ‹‰"},
                {id: 2, jp: "ã‚ªã‚¹ã‚¹ãƒ¡ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", zh: "æœ‰æ¨è–¦çš„å—ï¼Ÿ", romaji: "Osusume wa arimasuka?", note: "å–”è˜‡è˜‡å¦¹ æŒ–"}
            ]);
            const [expenses, setExpenses] = useState(() => JSON.parse(localStorage.getItem('expenses_v6')) || []);
            const [shoppingList, setShoppingList] = useState(() => JSON.parse(localStorage.getItem('shoppingList_v9')) || [
                {id: 1, name: "å”å‰è»»å¾·", items: [{id: 1764151988479, name: "å¤§çŒ©çŒ©æ¡åŠ›æŒ‰æ‘©", img: "https://megapx-assets.dcard.tw/images/7f0f30b2-f731-4392-a471-4f5b40192eb8/orig.jpeg", checked: false}, {id: 1764152008831, name: "é¹½æ˜†å¸ƒ", img: "", checked: false}, {id: 1764152022385, name: "è…³è‡­è—¥", img: "", checked: false}, {id: 1764152035229, name: "æ—¥æ¸…æ³¡éºµ*10", img: "", checked: false}], img: "https://i0.wp.com/boo2k.com/wp-content/uploads/2019/09/3C1A4903.jpg"},
                {id: 1764151759995, name: "3Coins ", items: [{id: 1764151771569, name: "Mini toy camera", img: "", checked: false}, {id: 1764151791946, name: "è€³æ©Ÿ", img: "", checked: false}, {id: 1764151804837, name: "å¾®æ³¢çˆçƒ¤ç›¤*4", img: "", checked: false}, {id: 1764151830465, name: "å£ç½©", img: "", checked: false}, {id: 1764151847589, name: "æ¡Œé¢ç„¡ç·šå……é›»å™¨", img: "", checked: false}, {id: 1764151863682, name: "æ›ç¹©å……é›»å™¨", img: "", checked: false}, {id: 1764151876704, name: "è¡Œæè¢‹", img: "", checked: false}, {id: 1764151893415, name: "ä¼¸ç¸®å……é›»ç·šæ”¶ç´ç›’", img: "", checked: false}, {id: 1764151911431, name: "æ—‹è½‰è—¥ç›’", img: "", checked: false}], img: "https://www.apiadome.com/share/img_uploads//pc/00001272_00003167_00000139.jpg"},
                {id: 1764151920947, name: "è—¥å±€", items: [{id: 1764151928097, name: "ç¶­ä»–å‘½C", img: "", checked: false}, {id: 1764151934484, name: "çœ¼è—¥æ°´", img: "", checked: false}, {id: 1764151941747, name: "è£œéµè»Ÿç³–", img: "", checked: false}, {id: 1764151949839, name: "ç— ç—›è²¼å¸ƒ", img: "", checked: false}, {id: 1764151975210, name: "è—è“é…µç´ ", img: "", checked: false}, {id: 1764152084481, name: "ç†±æ•·çœ¼ç½©", img: "", checked: false}, {id: 1764152102442, name: "é»‘çœ¼åœˆæ¶ˆé™¤ç¥å™¨", img: "", checked: false}, {id: 1764152128186, name: "æ­¢é¼¾ç¥å™¨", img: "", checked: false}, {id: 1764199506544, name: "å¤§æ­£å˜´ç ´è²¼ç‰‡", img: "", checked: false}], img: "https://files.parklane.com.tw/wp-content/uploads/2020/03/09184924/B2F-%E6%9D%BE%E6%9C%AC%E6%B8%85-%E5%8B%A4%E7%BE%8E%E8%AA%A0%E5%93%81%E5%BA%97LOGO.jpg"},
                {id: 1764152053403, name: "Lawson", items: [{id: 1764152061923, name: "è¯åé›¨å‚˜", img: "", checked: false}, {id: 1764152069073, name: "å»æ±¡ç´™å·¾", img: "", checked: false}], img: "https://www.kansai-airport.or.jp/sites/default/files/styles/tenant_image_main/public/2017-10/s093-main.png"}
            ]);
            const [packingItems, setPackingItems] = useState(() => JSON.parse(localStorage.getItem('packingItems_v10')) || [
                {id: 101, text: "âœ… è­‰ä»¶èˆ‡æ–‡ä»¶é¡", isHeader: true}, {id: 102, text: "è­·ç…§ï¼ˆæ•ˆæœŸ6å€‹æœˆä»¥ä¸Šï¼‰(åˆ‡è¨˜)", checked: false}, {id: 103, text: "æ©Ÿç¥¨ / é›»å­æ©Ÿç¥¨ç¢ºèªä¿¡", checked: false}, {id: 104, text: "Visit Japan Web", checked: false}, {id: 105, text: "é£¯åº—è¨‚æˆ¿è³‡è¨Š", checked: false}, {id: 106, text: "äº¤é€šç¥¨åˆ¸ï¼ˆICOCAï¼‰", checked: false}, {id: 201, text: "ğŸ’´ é‡‘éŒ¢èˆ‡æ”¯ä»˜å·¥å…·", isHeader: true}, {id: 202, text: "ç¾é‡‘æ—¥åœ“", checked: false}, {id: 203, text: "ä¿¡ç”¨å¡", checked: false}, {id: 301, text: "ğŸ“± æ‰‹æ©Ÿèˆ‡ç¶²è·¯", isHeader: true}, {id: 302, text: "eSIM", checked: false}, {id: 303, text: "å……é›»å™¨ / è¡Œå‹•é›»æº", checked: false}, {id: 401, text: "ğŸ§³ è¡£ç‰©èˆ‡ç”Ÿæ´»ç”¨å“", isHeader: true}, {id: 402, text: "å¥½èµ°çš„é‹", checked: false}, {id: 403, text: "å¤–å¥— / å‚˜", checked: false}, {id: 404, text: "è¡£ç‰©", checked: false}, {id: 407, text: "è—¥å“", checked: false}, {id: 501, text: "ğŸ› è³¼ç‰©èˆ‡é€€ç¨…", isHeader: true}, {id: 502, text: "è­·ç…§ï¼ˆé€€ç¨…ï¼‰", checked: false}, {id: 503, text: "è³¼ç‰©è¢‹", checked: false}
            ]);
            const [payType, setPayType] = useState('ç¾é‡‘'); // 'ç¾é‡‘' or 'ä¿¡ç”¨å¡'
            const [showSettings, setShowSettings] = useState(false);
            const [userApiKey, setUserApiKey] = useState(getApiKey());
            const [tempKey, setTempKey] = useState('');

            useEffect(() => { localStorage.setItem('itinerary_v23', JSON.stringify(itinerary)); }, [itinerary]);
            useEffect(() => { localStorage.setItem('checkin_v9', JSON.stringify(checkInData)); }, [checkInData]);
            useEffect(() => { localStorage.setItem('phrases_v9', JSON.stringify(phrases)); }, [phrases]);
            useEffect(() => { localStorage.setItem('expenses_v6', JSON.stringify(expenses)); }, [expenses]);
            useEffect(() => { localStorage.setItem('shoppingList_v9', JSON.stringify(shoppingList)); }, [shoppingList]);
            useEffect(() => { localStorage.setItem('packingItems_v10', JSON.stringify(packingItems)); }, [packingItems]);

            const saveApiKey = () => {
                localStorage.setItem('gemini_api_key', tempKey);
                setUserApiKey(tempKey);
                setShowSettings(false);
                alert('API Key å·²å„²å­˜ï¼');
            };

            const renderContent = () => {
                switch(activeTab) {
                    case 'home': return <Home phrases={phrases} setPhrases={setPhrases} checkInData={checkInData} setCheckInData={setCheckInData} allData={{itinerary, checkInData, phrases, expenses, shoppingList, packingItems}} setShowSettings={setShowSettings} />;
                    case 'itinerary': return <Itinerary itinerary={itinerary} setItinerary={setItinerary} />;
                    case 'shopping': return <Shopping list={shoppingList} setList={setShoppingList} />;
                    case 'finance': return <Finance expenses={expenses} setExpenses={setExpenses} payType={payType} setPayType={setPayType} />;
                    case 'packing': return <Packing items={packingItems} setItems={setPackingItems} />;
                    default: return <Home />;
                }
            };

            return (
                <div className="min-h-screen relative">
                    <main className="fade-in">{renderContent()}</main>
                    <nav className="fixed bottom-0 left-0 w-full liquid-nav pb-safe z-50">
                        <div className="flex justify-around items-center h-[90px] pb-2">
                            <NavBtn id="home" icon="leaf" label="é¦–é " active={activeTab} set={setActiveTab} />
                            <NavBtn id="itinerary" icon="map" label="è¡Œç¨‹" active={activeTab} set={setActiveTab} />
                            <NavBtn id="shopping" icon="shopping-bag" label="è³¼ç‰©" active={activeTab} set={setActiveTab} />
                            <NavBtn id="finance" icon="wallet" label="è¨˜å¸³" active={activeTab} set={setActiveTab} />
                            <NavBtn id="packing" icon="briefcase" label="è¡Œæ" active={activeTab} set={setActiveTab} />
                        </div>
                    </nav>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 fade-in">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl slide-up">
                                <h3 className="text-xl font-bold mb-4 text-[#4A3B32] flex items-center gap-2"><Icon name="settings" /> è¨­å®š</h3>
                                <div className="mb-4">
                                    <label className="block text-sm font-bold text-gray-700 mb-1">Google Gemini API Key</label>
                                    <p className="text-xs text-gray-500 mb-2">è«‹è²¼ä¸Šæ‚¨çš„ API Key ä»¥å•Ÿç”¨ç¿»è­¯èˆ‡å°éŠåŠŸèƒ½ã€‚</p>
                                    <input 
                                        type="password"
                                        value={tempKey} 
                                        onChange={e => setTempKey(e.target.value)} 
                                        placeholder={userApiKey ? "å·²è¨­å®š (è¼¸å…¥æ–° Key ä»¥è¦†è“‹)" : "è²¼ä¸Š API Key..."}
                                        className="w-full p-3 border rounded-xl outline-none focus:border-[#C04829]" 
                                    />
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowSettings(false)} className="flex-1 py-2 text-gray-500">å–æ¶ˆ</button>
                                    <button onClick={saveApiKey} className="flex-1 bg-[#C04829] text-white rounded-xl font-bold">å„²å­˜</button>
                                </div>
                                <div className="mt-4 text-center">
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-blue-500 underline">å–å¾—å…è²» API Key</a>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const NavBtn = ({ id, icon, label, active, set }) => {
            const isActive = active === id;
            return (
                <button onClick={() => set(id)} className={`relative flex flex-col items-center justify-center w-full h-full transition-all duration-300 ${isActive ? 'text-[#C04829] -translate-y-2' : 'text-[#8C7B70]'}`}>
                    <div className={`p-2 rounded-2xl transition-all duration-300 ${isActive ? 'bg-white shadow-lg shadow-[#C04829]/20' : ''}`}>
                        <Icon name={icon} size={24} className={isActive ? 'stroke-2' : 'stroke-1.5'} />
                    </div>
                    <span className={`text-[10px] mt-1 font-bold tracking-widest transition-opacity duration-300 ${isActive ? 'opacity-100' : 'opacity-0'}`}>{label}</span>
                    {isActive && <div className="absolute bottom-2 w-1 h-1 rounded-full bg-[#C04829]"></div>}
                </button>
            );
        }

        // --- PAGE: HOME ---
        const Home = ({ phrases, setPhrases, checkInData, setCheckInData, allData, setShowSettings }) => {
            const [showModal, setShowModal] = useState(false);
            const [showCheckIn, setShowCheckIn] = useState(false);
            const [checkInUser, setCheckInUser] = useState('xu');
            const [newPhrase, setNewPhrase] = useState({ zh: '', jp: '', romaji: '', note: '' });
            const [jpy, setJpy] = useState('');
            const [isTranslating, setIsTranslating] = useState(false);
            const [activeImgSection, setActiveImgSection] = useState(null); 

            const handleDelete = (id) => { setPhrases(phrases.filter(p => p.id !== id)); };
            const handleAdd = () => {
                if(!newPhrase.zh) return alert('è«‹è‡³å°‘è¼¸å…¥ä¸­æ–‡');
                setPhrases([...phrases, { ...newPhrase, id: Date.now() }]);
                setNewPhrase({ zh: '', jp: '', romaji: '', note: '' });
                setShowModal(false);
            };
            const handleCheckInChange = (field, val) => { setCheckInData({ ...checkInData, [checkInUser]: { ...checkInData[checkInUser], [field]: val } }); };
            const toggleImgSection = (section) => { setActiveImgSection(activeImgSection === section ? null : section); };
            const handleAITranslate = async () => {
                if (!newPhrase.zh) return alert('è«‹å…ˆè¼¸å…¥ä¸­æ–‡');
                setIsTranslating(true);
                try {
                    const prompt = `You are a Japanese translator. Translate "${newPhrase.zh}" to Japanese, Romaji, and Chinese homophone. Return JSON keys: "jp", "romaji", "note".`;
                    const result = await callGemini(prompt);
                    const data = JSON.parse(result.replace(/```json|```/g, '').trim());
                    setNewPhrase(prev => ({ ...prev, jp: data.jp, romaji: data.romaji, note: data.note }));
                } catch (e) { 
                    if(e.message === "NO_KEY") alert("è«‹å…ˆåœ¨å³ä¸Šè§’è¨­å®š API Key");
                    else alert('AI ç¿»è­¯å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯'); 
                } finally { setIsTranslating(false); }
            };
            const openWeather = () => window.open('https://www.jma.go.jp/bosai/forecast/#area_type=offices&area_code=270000', '_blank');
            const handleExport = () => {
                const dataStr = JSON.stringify(allData);
                const textArea = document.createElement("textarea");
                textArea.value = dataStr;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try { document.execCommand('copy'); alert('ä»£ç¢¼å·²è¤‡è£½ï¼è«‹è²¼çµ¦ AI æ›´æ–°ç¨‹å¼ç¢¼ã€‚'); } catch (err) { alert('è¤‡è£½å¤±æ•—'); }
                document.body.removeChild(textArea);
            };

            return (
                <div className="p-5 space-y-6 pb-24 relative">
                    <button onClick={() => setShowSettings(true)} className="absolute top-5 right-5 text-[#C04829] bg-white/80 p-2 rounded-full shadow-sm z-50"><Icon name="settings" size={20} /></button>
                    <FallingLeaves />
                    <div className="flex justify-between items-end mb-4 px-2 relative z-10">
                        <div><div className="text-[#C04829] font-bold text-xs tracking-[0.2em] mb-1">KYOTO & OSAKA</div><h1 className="text-3xl text-[#4A3B32] font-bold">æ—…ã®ç§‹</h1></div>
                        <Icon name="cloud-sun" className="text-[#D68C45]" size={32} />
                    </div>

                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-[#E8D5B5]/50 relative z-10">
                        <h3 className="font-bold text-[#4A3B32] mb-2 flex items-center gap-2"><Icon name="save" size={16}/> å‚™ä»½èˆ‡äº¤æ¥</h3>
                        <p className="text-xs text-[#8C7B70] mb-3">è‹¥è¦å°‡è³‡æ–™æ°¸ä¹…å„²å­˜ï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•è¤‡è£½ä»£ç¢¼è²¼çµ¦ AIã€‚</p>
                        <button onClick={handleExport} className="w-full bg-[#4A3B32] text-white py-2 rounded-xl font-bold text-sm shadow active:scale-95 transition-transform">è¤‡è£½è³‡æ–™ä»£ç¢¼</button>
                    </div>

                    <div onClick={openWeather} className="bg-gradient-to-br from-[#C04829] to-[#D68C45] rounded-3xl p-6 text-white shadow-xl shadow-[#C04829]/30 relative overflow-hidden active:scale-[0.98] transition-transform cursor-pointer z-10">
                        <div className="relative z-10 flex justify-between items-center pointer-events-none">
                            <div><div className="text-white/80 text-xs font-bold mb-1">ä»Šæ—¥å¤§é˜ª</div><div className="text-5xl font-light tracking-tighter">16Â°</div><div className="text-sm mt-2 font-medium opacity-90">æ™´æ™‚å¤šé›² Â· èˆ’é© <Icon name="external-link" size={12} className="inline ml-1"/></div></div>
                            <div className="text-white/90"><Icon name="sun" size={64} /></div>
                        </div>
                        <div className="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-2xl"></div>
                    </div>

                    <button onClick={() => setShowCheckIn(true)} className="w-full bg-white p-4 rounded-2xl shadow-sm border border-[#E8D5B5]/50 flex items-center justify-between group active:scale-[0.98] transition-transform relative z-10">
                        <div className="flex items-center gap-3">
                            <div className="bg-[#E0F2FE] p-2 rounded-xl text-[#0369A1]"><Icon name="ticket" size={20}/></div>
                            <div className="text-left"><div className="font-bold text-[#4A3B32]">Check In è³‡è¨Š</div><div className="text-xs text-[#8C7B70]">ç­æ©Ÿã€é£¯åº—è³‡è¨Šå¡</div></div>
                        </div>
                        <Icon name="chevron-right" className="text-[#D68C45]" />
                    </button>

                    <div className="bg-white rounded-2xl p-5 shadow-sm border border-[#E8D5B5]/30 relative z-10">
                        <div className="flex items-center gap-2 text-[#8C7B70] text-xs font-bold mb-3"><Icon name="refresh-ccw" size={12} /> å³æ™‚åŒ¯ç‡æ›ç®—</div>
                        <div className="flex items-center gap-4">
                            <div className="flex-1 bg-[#FAFAF5] rounded-xl px-3 py-2"><div className="text-[10px] text-[#8C7B70] mb-1">JPY æ—¥å¹£</div><input type="number" inputMode="decimal" value={jpy} onChange={e => setJpy(e.target.value)} className="w-full bg-transparent text-xl font-bold text-[#4A3B32] outline-none placeholder-[#D1C7C0]" placeholder="0" /></div>
                            <Icon name="arrow-right-left" className="text-[#D68C45]" size={20} />
                            <div className="flex-1 bg-[#FAFAF5] rounded-xl px-3 py-2"><div className="text-[10px] text-[#8C7B70] mb-1">TWD å°å¹£</div><div className="text-xl font-bold text-[#4A3B32]">{Math.floor(jpy * EXCHANGE_RATE)}</div></div>
                        </div>
                    </div>

                    <div className="relative z-10">
                        <div className="flex justify-between items-center mb-4 px-2">
                            <h2 className="text-lg font-bold text-[#4A3B32] flex items-center gap-2"><Icon name="message-circle" size={18} className="text-[#C04829]" /> å¯¦ç”¨æ—¥èª</h2>
                            <button onClick={() => setShowModal(true)} className="text-xs bg-[#4A3B32] text-white px-3 py-1.5 rounded-full shadow-md hover:bg-[#C04829] transition-colors">+ æ–°å¢èªå¥</button>
                        </div>
                        <div className="space-y-3">
                            <div className="text-xs text-gray-400 text-center mb-2">ğŸ’¡ å‘å·¦æ»‘å‹•é¡¯ç¤ºåˆªé™¤</div>
                            {phrases.map(p => (
                                <SwipeItem key={p.id} onAction={() => handleDelete(p.id)}>
                                    <div className="flex justify-between items-start p-4">
                                        <div><div className="font-bold text-[#4A3B32] text-lg">{p.zh}</div><div className="text-[#C04829] font-medium mt-1">{p.jp}</div><div className="text-xs text-[#8C7B70] mt-1 italic">{p.romaji}</div></div>
                                        {p.note && <div className="bg-[#FFF8EB] text-[#D68C45] px-2 py-1 rounded-lg text-xs font-bold">{p.note}</div>}
                                    </div>
                                </SwipeItem>
                            ))}
                        </div>
                    </div>

                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 fade-in modal-z">
                            <div className="bg-[#FAFAF5] w-full max-w-md rounded-3xl p-6 shadow-2xl slide-up max-h-[85vh] overflow-y-auto relative flex flex-col">
                                <h3 className="text-xl font-bold mb-4 text-[#4A3B32]">æ–°å¢æ—¥èª</h3>
                                <div className="space-y-4 flex-1">
                                    <div className="relative"><input placeholder="ä¸­æ–‡" value={newPhrase.zh} onChange={e=>setNewPhrase({...newPhrase, zh: e.target.value})} className="w-full p-3 rounded-xl border border-[#E8D5B5] outline-none focus:border-[#C04829]" /><button onClick={handleAITranslate} disabled={isTranslating} className="absolute right-2 top-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-md flex items-center gap-1">{isTranslating ? <div className="spinner"></div> : <><Icon name="sparkles" size={12}/> AI ç¿»è­¯</>}</button></div>
                                    <input placeholder="æ—¥æ–‡" value={newPhrase.jp} onChange={e=>setNewPhrase({...newPhrase, jp: e.target.value})} className="w-full p-3 rounded-xl border border-[#E8D5B5] outline-none" />
                                    <input placeholder="è‹±æ–‡æ‹¼éŸ³" value={newPhrase.romaji} onChange={e=>setNewPhrase({...newPhrase, romaji: e.target.value})} className="w-full p-3 rounded-xl border border-[#E8D5B5] outline-none" />
                                    <input placeholder="ä¸­æ–‡è«§éŸ³å‚™è¨»" value={newPhrase.note} onChange={e=>setNewPhrase({...newPhrase, note: e.target.value})} className="w-full p-3 rounded-xl border border-[#E8D5B5] outline-none" />
                                </div>
                                <div className="flex gap-3 mt-6"><button onClick={() => setShowModal(false)} className="flex-1 py-3 text-[#8C7B70]">å–æ¶ˆ</button><button onClick={handleAdd} className="flex-1 bg-[#C04829] text-white rounded-xl font-bold shadow-lg">ç¢ºèªæ–°å¢</button></div>
                            </div>
                        </div>
                    )}

                    {showCheckIn && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-end sm:items-center justify-center fade-in modal-z">
                            <div className="bg-[#FAFAF5] w-full h-[85vh] sm:h-auto sm:w-[90%] max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl slide-up flex flex-col">
                                <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-[#4A3B32]">Check In è³‡è¨Š</h3><button onClick={()=>setShowCheckIn(false)}><Icon name="x" className="text-[#8C7B70]"/></button></div>
                                <div className="bg-white border border-[#E8D5B5] p-1 rounded-full flex gap-1 shadow-sm mb-6 shrink-0"><button onClick={()=>setCheckInUser('xu')} className={`flex-1 py-2 rounded-full text-sm font-bold transition-all ${checkInUser==='xu'?'bg-[#7D8A58] text-white shadow':'text-[#8C7B70]'}`}>æ—­ (Xu)</button><button onClick={()=>setCheckInUser('zhen')} className={`flex-1 py-2 rounded-full text-sm font-bold transition-all ${checkInUser==='zhen'?'bg-[#D68C45] text-white shadow':'text-[#8C7B70]'}`}>è“ (Zhen)</button></div>
                                <div className="space-y-4 overflow-y-auto flex-1 no-scrollbar">
                                    <div className="bg-white p-4 rounded-2xl border border-[#E8D5B5]">
                                        <div className="flex items-center justify-between mb-2"><div className="flex items-center gap-2 text-[#C04829] font-bold"><Icon name="plane-takeoff" size={18}/> èµ·é£› Departure</div><button onClick={()=>toggleImgSection('depart')} className="text-[#D68C45] bg-[#FFF0EB] p-2 rounded-lg flex items-center gap-1"><Icon name="image" size={16}/><span className="text-xs">ç…§ç‰‡</span></button></div>
                                        {activeImgSection === 'depart' && <div className="mb-3"><ImageUploader currentImage={checkInData[checkInUser].departImg} onImageChange={img => handleCheckInChange('departImg', img)} height="h-40" label="ä¸Šå‚³æ©Ÿç¥¨/æˆªåœ–" /></div>}
                                        <textarea value={checkInData[checkInUser].depart} onChange={e=>handleCheckInChange('depart', e.target.value)} className="w-full h-20 p-2 bg-[#FAFAF5] rounded-xl outline-none text-sm resize-none" placeholder="è¼¸å…¥èµ·é£›è³‡è¨Š..." />
                                    </div>
                                    <div className="bg-white p-4 rounded-2xl border border-[#E8D5B5]">
                                        <div className="flex items-center justify-between mb-2"><div className="flex items-center gap-2 text-[#0369A1] font-bold"><Icon name="plane-landing" size={18}/> å›ç¨‹ Return</div><button onClick={()=>toggleImgSection('back')} className="text-[#0369A1] bg-[#F0F9FF] p-2 rounded-lg flex items-center gap-1"><Icon name="image" size={16}/><span className="text-xs">ç…§ç‰‡</span></button></div>
                                        {activeImgSection === 'back' && <div className="mb-3"><ImageUploader currentImage={checkInData[checkInUser].backImg} onImageChange={img => handleCheckInChange('backImg', img)} height="h-40" label="ä¸Šå‚³æ©Ÿç¥¨/æˆªåœ–" /></div>}
                                        <textarea value={checkInData[checkInUser].back} onChange={e=>handleCheckInChange('back', e.target.value)} className="w-full h-20 p-2 bg-[#FAFAF5] rounded-xl outline-none text-sm resize-none" placeholder="è¼¸å…¥å›ç¨‹è³‡è¨Š..." />
                                    </div>
                                    <div className="bg-white p-4 rounded-2xl border border-[#E8D5B5]">
                                        <div className="flex items-center justify-between mb-2"><div className="flex items-center gap-2 text-[#15803D] font-bold"><Icon name="hotel" size={18}/> å…¥ä½ Accommodation</div><button onClick={()=>toggleImgSection('hotel')} className="text-[#15803D] bg-[#F0FDF4] p-2 rounded-lg flex items-center gap-1"><Icon name="image" size={16}/><span className="text-xs">ç…§ç‰‡</span></button></div>
                                        {activeImgSection === 'hotel' && <div className="mb-3"><ImageUploader currentImage={checkInData[checkInUser].hotelImg} onImageChange={img => handleCheckInChange('hotelImg', img)} height="h-40" label="ä¸Šå‚³è¨‚æˆ¿æ†‘è­‰" /></div>}
                                        <textarea value={checkInData[checkInUser].hotel} onChange={e=>handleCheckInChange('hotel', e.target.value)} className="w-full h-24 p-2 bg-[#FAFAF5] rounded-xl outline-none text-sm resize-none" placeholder="è¼¸å…¥é£¯åº—åœ°å€ã€Check-in ä»£ç¢¼..." />
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- PAGE: ITINERARY ---
        const Itinerary = ({ itinerary, setItinerary }) => {
            const [selectedDate, setSelectedDate] = useState(getDefaultDate());
            const [viewingSpot, setViewingSpot] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [viewer, setViewer] = useState('xu');
            const isSplitDate = ['12/02', '12/03', '12/04'].includes(selectedDate);
            const currentSpots = useMemo(() => {
                const spots = itinerary[selectedDate] || [];
                let filtered = isSplitDate 
                    ? spots.filter(s => !s.owner || s.owner === 'common' || s.owner === viewer)
                    : spots;
                
                return [...filtered].sort((a, b) => a.time.localeCompare(b.time));
            }, [selectedDate, itinerary, viewer, isSplitDate]);

            const addNewSpot = () => {
                const owner = isSplitDate ? viewer : 'common';
                const newSpot = { id: Date.now(), time: '00:00', place: 'æ–°è¡Œç¨‹', desc: 'é»æ“Šç·¨è¼¯è©³æƒ…', image: '', owner, mapUrl: '' };
                setItinerary({ ...itinerary, [selectedDate]: [...(itinerary[selectedDate]||[]), newSpot] });
            };
            const updateSpot = (updatedSpot) => {
                setItinerary({ ...itinerary, [selectedDate]: itinerary[selectedDate].map(s => s.id === updatedSpot.id ? updatedSpot : s) });
                if (viewingSpot && viewingSpot.id === updatedSpot.id) setViewingSpot(updatedSpot);
            };
            
            // FIXED: Direct Delete without Confirm for better touch response
            const deleteSpot = (id) => {
                setItinerary(prev => ({
                    ...prev,
                    [selectedDate]: prev[selectedDate].filter(s => s.id !== id)
                }));
                setViewingSpot(null);
            };

            const handleAIGuide = async () => {
                setIsGenerating(true);
                try {
                    const prompt = `Write a short guide for "${viewingSpot.place}" in Kyoto/Osaka. Include interesting story, "å¿…åƒ" food, "å¿…è²·" souvenir. Traditional Chinese.`;
                    const text = await callGemini(prompt);
                    updateSpot({ ...viewingSpot, desc: text });
                } catch (e) { 
                    if(e.message === "NO_KEY") alert("è«‹å…ˆåœ¨é¦–é è¨­å®š API Key");
                    else alert('AI éŒ¯èª¤'); 
                } finally { setIsGenerating(false); }
            };
            const openMap = (e, spot) => {
                e.stopPropagation();
                const url = spot.mapUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(spot.place)}`;
                window.open(url, '_blank');
            };

            return (
                <div className="flex flex-col h-screen pb-24">
                    <div className="bg-[#FAFAF5]/95 backdrop-blur-sm z-30 sticky top-0 pt-4 pb-2 border-b border-[#E8D5B5]/50">
                        <div className="flex justify-center overflow-x-auto no-scrollbar px-4 gap-3 pb-2 w-full">
                            {DATES.map((d) => {
                                const isSelected = selectedDate === d.date;
                                return (
                                    <button key={d.date} onClick={() => setSelectedDate(d.date)} className={`flex flex-col items-center min-w-[65px] p-3 rounded-2xl transition-all ${isSelected ? 'bg-[#C04829] text-white shadow-lg scale-105' : 'bg-white text-[#8C7B70] border border-[#E8D5B5]/50'}`}>
                                        <span className={`font-bold mb-1 ${isSelected?'text-base':'text-xs'}`}>{d.date}</span>
                                        <Icon name={d.weather === 'sunny' ? 'sun' : d.weather === 'rain' ? 'cloud-rain' : 'cloud'} size={isSelected?20:18} />
                                        <span className="text-[10px] mt-1 opacity-80">{d.temp}</span>
                                    </button>
                                );
                            })}
                        </div>
                        {isSplitDate && (
                             <div className="flex justify-center mt-2 pb-1 fade-in">
                                <div className="bg-white border border-[#E8D5B5] p-1 rounded-full flex gap-1 shadow-sm">
                                    <button onClick={()=>setViewer('xu')} className={`px-6 py-1.5 rounded-full text-xs font-bold transition-all ${viewer==='xu'?'bg-[#7D8A58] text-white shadow':'text-[#8C7B70]'}`}>æ—­ (Xu)</button>
                                    <button onClick={()=>setViewer('zhen')} className={`px-6 py-1.5 rounded-full text-xs font-bold transition-all ${viewer==='zhen'?'bg-[#D68C45] text-white shadow':'text-[#8C7B70]'}`}>è“ (Zhen)</button>
                                </div>
                             </div>
                        )}
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-6">
                        <div className="text-center text-[#8C7B70] text-sm font-bold tracking-widest opacity-60">â€” {selectedDate} è¡Œç¨‹ â€”</div>
                        {currentSpots.length === 0 ? <div className="text-center text-gray-400 py-10 flex flex-col items-center">å°šç„¡è¡Œç¨‹</div> : currentSpots.map(spot => (
                            <SwipeItem key={spot.id} link={spot.mapUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(spot.place)}`} label="å°èˆª" icon="map-pin" color="#0ea5e9">
                                <div onClick={() => setViewingSpot(spot)} className="flex flex-col bg-white">
                                    <div className="h-40 w-full bg-gray-100 relative">
                                        {spot.image ? <img src={spot.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-[#E8D5B5]/50"><Icon name="image" size={32} /></div>}
                                        <div className="absolute top-2 left-2 bg-white/90 backdrop-blur px-2 py-1 rounded-lg text-xs font-bold text-[#C04829] shadow-sm">{spot.time}</div>
                                    </div>
                                    <div className="p-4">
                                        <div className="flex justify-between items-start mb-2 gap-2">
                                            <div className="font-bold text-[#4A3B32] text-xl flex-1 leading-tight">{spot.place}</div>
                                            <Icon name="chevron-right" className="text-gray-300" size={20} />
                                        </div>
                                        <div className="line-clamp-2"><SmartText text={spot.desc} /></div>
                                    </div>
                                </div>
                            </SwipeItem>
                        ))}
                        <button onClick={addNewSpot} className="w-full py-4 border-2 border-dashed border-[#D68C45]/30 rounded-2xl text-[#D68C45] font-bold">+ æ–°å¢è¡Œç¨‹</button>
                    </div>
                    {viewingSpot && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in modal-z">
                            <div className="bg-[#FAFAF5] w-full max-w-md rounded-3xl p-6 shadow-2xl slide-up max-h-[90vh] overflow-y-auto flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <button onClick={() => setViewingSpot(null)} className="p-2 bg-white rounded-full shadow-sm"><Icon name="arrow-left" /></button>
                                    <span className="font-bold text-[#4A3B32]">è¡Œç¨‹è©³æƒ…</span>
                                    <button onClick={() => deleteSpot(viewingSpot.id)} className="text-white bg-red-500 px-4 py-2 rounded-xl text-sm font-bold shadow-md active:scale-95 transition-transform flex items-center gap-1"><Icon name="trash-2" size={16}/> åˆªé™¤</button>
                                </div>
                                
                                <div className="space-y-4 overflow-y-auto flex-1 pb-20">
                                    <ImageUploader currentImage={viewingSpot.image} onImageChange={(img) => updateSpot({ ...viewingSpot, image: img })} height="h-48"/>
                                    
                                    <div className="flex flex-col gap-4">
                                        <div><label className="text-xs text-[#8C7B70] font-bold mb-1 block">æ™‚é–“</label><input type="time" value={viewingSpot.time} onChange={(e) => updateSpot({...viewingSpot, time: e.target.value})} className="w-full p-3 bg-white rounded-xl border border-[#E8D5B5] font-bold text-[#4A3B32]" /></div>
                                        <div><label className="text-xs text-[#8C7B70] font-bold mb-1 block">åœ°é»</label><input type="text" value={viewingSpot.place} onChange={(e) => updateSpot({...viewingSpot, place: e.target.value})} className="w-full p-3 bg-white rounded-xl border border-[#E8D5B5] font-bold text-[#4A3B32]" /></div>
                                    </div>

                                    <div>
                                        <div className="flex justify-between items-center mb-1"><label className="text-xs text-[#8C7B70] font-bold block">åš®å°èªªæ˜èˆ‡å‚™è¨»</label><button onClick={handleAIGuide} disabled={isGenerating} className="text-xs bg-gradient-to-r from-[#D68C45] to-[#C04829] text-white px-3 py-1 rounded-full shadow-sm flex items-center gap-1">{isGenerating ? <div className="spinner"></div> : <><Icon name="sparkles" size={12}/> AI å°éŠ</>}</button></div>
                                        <textarea value={viewingSpot.desc} onChange={(e) => updateSpot({...viewingSpot, desc: e.target.value})} className="w-full h-32 p-4 bg-white rounded-xl border border-[#E8D5B5] text-[#4A3B32] resize-none outline-none" placeholder="è¡Œç¨‹èªªæ˜..."></textarea>
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs text-[#8C7B70] font-bold mb-1 block flex items-center gap-1"><Icon name="link" size={12}/> Google Maps é€£çµ (åŒæ­¥å‚™ä»½)</label>
                                        <div className="flex gap-2">
                                            <input type="text" value={viewingSpot.mapUrl || ''} onChange={(e) => updateSpot({...viewingSpot, mapUrl: e.target.value})} className="flex-1 p-3 bg-white rounded-xl border border-[#E8D5B5] text-sm text-gray-500 outline-none" placeholder="è²¼ä¸Šç¶²å€å„ªå…ˆå°èˆª..." />
                                            {/* Use explicit anchor for reliable navigation */}
                                            <a href={viewingSpot.mapUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(viewingSpot.place)}`} target="_blank" rel="noopener noreferrer" className="bg-blue-500 text-white px-4 rounded-xl font-bold text-sm shadow-md whitespace-nowrap flex items-center justify-center">å‰å¾€</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- PAGE: SHOPPING ---
        const Shopping = ({ list, setList }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newStore, setNewStore] = useState({ name: '', img: '' });
            const [activeStore, setActiveStore] = useState(null);
            const [addingItemTo, setAddingItemTo] = useState(null);
            const [newItem, setNewItem] = useState({ name: '', img: '' });
            
            // Edit States
            const [editingItem, setEditingItem] = useState(null); // {storeId, itemId, name, img}

            const handleAddStore = () => { if(!newStore.name) return; setList([...list, { id: Date.now(), name: newStore.name, items: [], img: newStore.img }]); setNewStore({ name: '', img: '' }); setIsAdding(false); };
            const toggleItem = (storeId, itemId) => { setList(list.map(s => { if(s.id === storeId) { return { ...s, items: s.items.map(i => i.id === itemId ? { ...i, checked: !i.checked } : i) }; } return s; })); };
            const handleAddItem = () => { if(!newItem.name) return; setList(list.map(s => s.id === addingItemTo ? { ...s, items: [...s.items, { id: Date.now(), name: newItem.name, img: newItem.img, checked: false }] } : s)); setNewItem({ name: '', img: '' }); setAddingItemTo(null); };
            const handleDeleteItem = (storeId, itemId) => { setList(list.map(s => s.id === storeId ? { ...s, items: s.items.filter(i => i.id !== itemId) } : s)); };
            
            // Save Edit
            const saveEdit = () => {
                if(!editingItem) return;
                if(editingItem.itemId) {
                    // Update Item
                    setList(list.map(s => s.id === editingItem.storeId ? {
                        ...s, items: s.items.map(i => i.id === editingItem.itemId ? { ...i, name: editingItem.name, img: editingItem.img } : i)
                    } : s));
                } else {
                    // Update Store
                    setList(list.map(s => s.id === editingItem.storeId ? { ...s, name: editingItem.name, img: editingItem.img } : s));
                }
                setEditingItem(null);
            };

            if (activeStore) {
                const store = list.find(s => s.id === activeStore.id) || activeStore;
                return (
                    <div className="p-4 pb-24 min-h-screen bg-white">
                        <button onClick={() => setActiveStore(null)} className="mb-4 flex items-center gap-1 text-[#8C7B70]"><Icon name="chevron-left"/> è¿”å›æ¸…å–®</button>
                        <div className="h-40 w-full rounded-2xl overflow-hidden relative mb-6 bg-gray-100">
                            {store.img ? <img src={store.img} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-[#D68C45]"><Icon name="store" size={40}/></div>}
                            <div className="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/60 to-transparent p-4"><h2 className="text-white font-bold text-2xl">{store.name}</h2></div>
                        </div>
                        <div className="space-y-3">
                            {store.items.map(item => (
                                <SwipeItem key={item.id} onAction={() => handleDeleteItem(store.id, item.id)}>
                                    <div onClick={() => toggleItem(store.id, item.id)} className={`p-3 rounded-xl border flex items-center gap-3 bg-white border-[#E8D5B5] shadow-sm relative`}>
                                        <div className="w-12 h-12 rounded-lg bg-gray-100 overflow-hidden shrink-0 relative">
                                            {item.img ? <img src={item.img} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-gray-300"><Icon name="image" size={16}/></div>}
                                        </div>
                                        
                                        {/* Edit Item Button */}
                                        <button 
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setEditingItem({ storeId: store.id, itemId: item.id, name: item.name, img: item.img });
                                            }} 
                                            className="absolute top-1 right-1 text-gray-400 p-2 z-20 active:text-[#C04829]"
                                        >
                                            <Icon name="pencil" size={14} />
                                        </button>

                                        <div className="flex-1"><span className={`font-bold block ${item.checked ? 'line-through text-gray-400' : 'text-[#4A3B32]'}`}>{item.name}</span></div>
                                        {item.checked && <Icon name="check" className="text-green-500 shrink-0" />}
                                    </div>
                                </SwipeItem>
                            ))}
                            <button onClick={() => setAddingItemTo(store.id)} className="w-full py-3 rounded-xl border border-dashed border-[#D68C45] text-[#D68C45]">+ æ–°å¢å•†å“</button>
                        </div>
                        
                        {/* Modals for Adding/Editing */}
                        {addingItemTo && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in modal-z"><div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 className="text-xl font-bold text-[#4A3B32] mb-4">æ–°å¢å•†å“</h3><input placeholder="å•†å“åç¨±" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} className="w-full p-3 border border-[#E8D5B5] rounded-xl mb-4" /><div className="mb-4"><label className="text-xs font-bold text-[#8C7B70] mb-2 block">å•†å“ç…§ç‰‡</label><ImageUploader currentImage={newItem.img} onImageChange={img => setNewItem({...newItem, img})} height="h-24"/></div><div className="flex gap-2"><button onClick={() => setAddingItemTo(null)} className="flex-1 py-3 text-[#8C7B70]">å–æ¶ˆ</button><button onClick={handleAddItem} className="flex-1 bg-[#C04829] text-white rounded-xl font-bold">æ–°å¢</button></div></div></div>)}
                        
                        {/* Edit Item Modal */}
                        {editingItem && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in modal-z">
                                <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                                    <h3 className="text-xl font-bold text-[#4A3B32] mb-4">ç·¨è¼¯å•†å“</h3>
                                    <input 
                                        placeholder="å•†å“åç¨±" 
                                        value={editingItem.name} 
                                        onChange={e => setEditingItem({...editingItem, name: e.target.value})} 
                                        className="w-full p-3 border border-[#E8D5B5] rounded-xl mb-4" 
                                    />
                                    <div className="mb-4">
                                        <label className="text-xs font-bold text-[#8C7B70] mb-2 block">æ›´æ›åœ–ç‰‡</label>
                                        <ImageUploader 
                                            currentImage={editingItem.img} 
                                            onImageChange={img => setEditingItem({...editingItem, img: img})} 
                                            height="h-32"
                                        />
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setEditingItem(null)} className="flex-1 py-3 text-[#8C7B70]">å–æ¶ˆ</button>
                                        <button onClick={saveEdit} className="flex-1 bg-[#C04829] text-white rounded-xl font-bold">å„²å­˜</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            return (
                <div className="p-4 pb-24">
                     <div className="flex justify-between items-center mb-6"><h1 className="text-2xl font-bold text-[#4A3B32]">è³¼ç‰©æ¸…å–®</h1><button onClick={() => setIsAdding(true)} className="text-sm bg-[#C04829] text-white px-4 py-2 rounded-full shadow-lg">+ æ–°å¢åº—å®¶</button></div>
                    <div className="grid grid-cols-2 gap-4">{list.map(store => (
                        <SwipeItem key={store.id} onAction={() => setList(list.filter(s => s.id !== store.id))}>
                            <div onClick={() => setActiveStore(store)} className="rounded-2xl overflow-hidden shadow-sm border border-[#E8D5B5]/50 group h-full bg-white relative">
                                <div className="h-28 bg-[#FAFAF5] relative">{store.img ? <img src={store.img} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-[#E8D5B5]"><Icon name="image" /></div>}</div>
                                
                                {/* Edit Store Button */}
                                <button 
                                    onClick={(e) => {
                                        e.stopPropagation(); 
                                        setEditingItem({ storeId: store.id, itemId: null, name: store.name, img: store.img });
                                    }} 
                                    className="absolute top-2 right-2 bg-white/90 p-1.5 rounded-lg shadow z-20 active:bg-gray-200"
                                >
                                    <Icon name="pencil" size={14}/>
                                </button>

                                <div className="p-4"><h3 className="font-bold text-[#4A3B32]">{store.name}</h3><p className="text-xs text-[#8C7B70] mt-1">{store.items.length} å€‹å¾…è²·é …ç›®</p></div>
                            </div>
                        </SwipeItem>
                    ))}</div>
                    
                    {isAdding && (<div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in modal-z"><div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl"><h3 className="text-xl font-bold text-[#4A3B32] mb-4">æ–°å¢åº—å®¶</h3><input placeholder="åº—å®¶åç¨±" value={newStore.name} onChange={e => setNewStore({...newStore, name: e.target.value})} className="w-full p-3 border border-[#E8D5B5] rounded-xl mb-4" /><div className="mb-4"><label className="text-xs font-bold text-[#8C7B70] mb-2 block">å°é¢ç…§ç‰‡</label><ImageUploader currentImage={newStore.img} onImageChange={img => setNewStore({...newStore, img})} /></div><div className="flex gap-2"><button onClick={() => setIsAdding(false)} className="flex-1 py-3 text-[#8C7B70]">å–æ¶ˆ</button><button onClick={handleAddStore} className="flex-1 bg-[#C04829] text-white rounded-xl font-bold">æ–°å¢</button></div></div></div>)}
                    
                    {/* Edit Store Modal */}
                    {editingItem && !editingItem.itemId && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in modal-z">
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                                <h3 className="text-xl font-bold text-[#4A3B32] mb-4">ç·¨è¼¯åº—å®¶</h3>
                                <input 
                                    placeholder="åº—å®¶åç¨±" 
                                    value={editingItem.name} 
                                    onChange={e => setEditingItem({...editingItem, name: e.target.value})} 
                                    className="w-full p-3 border border-[#E8D5B5] rounded-xl mb-4" 
                                />
                                <div className="mb-4">
                                    <label className="text-xs font-bold text-[#8C7B70] mb-2 block">å°é¢ç…§ç‰‡</label>
                                    <ImageUploader 
                                        currentImage={editingItem.img} 
                                        onImageChange={img => setEditingItem({...editingItem, img: img})} 
                                    />
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setEditingItem(null)} className="flex-1 py-3 text-[#8C7B70]">å–æ¶ˆ</button>
                                    <button onClick={saveEdit} className="flex-1 bg-[#C04829] text-white rounded-xl font-bold">å„²å­˜</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- PAGE: FINANCE ---
        const Finance = ({ expenses, setExpenses, payType, setPayType }) => {
            const [amount, setAmount] = useState('');
            const [note, setNote] = useState('');
            const [cat, setCat] = useState('é£Ÿ');
            const [filterCat, setFilterCat] = useState('All');
            const cats = ['é£Ÿ', 'è¡£', 'ä½', 'è¡Œ', 'æ¨‚', 'è²·'];
            
            const addExpense = () => { if (!amount) return; setExpenses([{ id: Date.now(), amount: parseInt(amount), note, cat, method: payType, date: new Date().toLocaleDateString() }, ...expenses]); setAmount(''); setNote(''); };
            const deleteExpense = (id) => { setExpenses(expenses.filter(e => e.id !== id)); };
            const filteredExpenses = filterCat === 'All' ? expenses : expenses.filter(e => e.cat === filterCat);
            const total = filteredExpenses.reduce((acc, curr) => acc + curr.amount, 0);

            return (
                <div className="p-4 pb-24">
                    <h1 className="text-2xl font-bold text-[#4A3B32] mb-4">è¨˜å¸³æœ¬</h1>
                    <div className="bg-white rounded-3xl p-6 shadow-sm border border-[#E8D5B5]/50 mb-6">
                        <div className="flex justify-between items-end mb-4"><span className="text-sm text-[#8C7B70]">è¼¸å…¥é‡‘é¡ (Â¥)</span><div className="text-right"><div className="text-3xl font-bold text-[#4A3B32]">{amount || 0}</div><div className="text-xs text-[#C04829]">â‰ˆ NT$ {Math.floor((amount||0) * EXCHANGE_RATE)}</div></div></div>
                        <div className="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-1">{cats.map(c => { const colors = CAT_COLORS[c]; const isSelected = cat === c; return (<button key={c} onClick={() => setCat(c)} className={`px-4 py-2 rounded-xl text-sm font-bold transition-all border ${isSelected ? 'shadow-md scale-105' : 'border-transparent bg-[#FAFAF5] text-[#8C7B70]'}`} style={isSelected ? { backgroundColor: colors.bg, color: colors.text, borderColor: colors.border } : {}}>{c}</button>); })}</div>
                        
                        {/* Payment Method Toggle */}
                        <div className="flex gap-2 mb-4">
                            <button onClick={() => setPayType('ç¾é‡‘')} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all border ${payType === 'ç¾é‡‘' ? 'bg-[#4A3B32] text-white' : 'bg-white text-[#8C7B70] border-[#E8D5B5]'}`}>ğŸ’´ ç¾é‡‘</button>
                            <button onClick={() => setPayType('ä¿¡ç”¨å¡')} className={`flex-1 py-2 rounded-xl text-sm font-bold transition-all border ${payType === 'ä¿¡ç”¨å¡' ? 'bg-[#4A3B32] text-white' : 'bg-white text-[#8C7B70] border-[#E8D5B5]'}`}>ğŸ’³ ä¿¡ç”¨å¡</button>
                        </div>

                        <div className="grid grid-cols-4 gap-2"><input type="number" inputMode="decimal" value={amount} onChange={e => setAmount(e.target.value)} className="col-span-4 p-3 bg-[#FAFAF5] rounded-xl outline-none font-bold text-lg" placeholder="é‡‘é¡" /><input type="text" value={note} onChange={e => setNote(e.target.value)} className="col-span-3 p-3 bg-[#FAFAF5] rounded-xl outline-none" placeholder="å‚™è¨»..." /><button onClick={addExpense} className="col-span-1 bg-[#C04829] text-white rounded-xl flex items-center justify-center shadow-lg"><Icon name="plus" /></button></div>
                    </div>
                    
                    <div className="flex gap-2 mb-4 overflow-x-auto no-scrollbar pb-1 px-2">
                        <button onClick={() => setFilterCat('All')} className={`px-3 py-1 rounded-full text-xs font-bold border ${filterCat === 'All' ? 'bg-[#4A3B32] text-white' : 'bg-white text-[#8C7B70] border-[#E8D5B5]'}`}>å…¨éƒ¨</button>
                        {cats.map(c => (<button key={c} onClick={() => setFilterCat(c)} className={`px-3 py-1 rounded-full text-xs font-bold border ${filterCat === c ? 'bg-[#C04829] text-white' : 'bg-white text-[#8C7B70] border-[#E8D5B5]'}`}>{c}</button>))}
                    </div>

                    <div className="space-y-3"><div className="flex justify-between text-xs text-[#8C7B70] px-2"><span>{filterCat === 'All' ? 'ç¸½åˆ—è¡¨' : `${filterCat}é¡åˆ—è¡¨`}</span><span>ç¸½è¨ˆ Â¥{total.toLocaleString()}</span></div>{filteredExpenses.map(e => { const colors = CAT_COLORS[e.cat] || { bg: '#f3f4f6', text: '#374151', border: '#e5e7eb' }; return (<SwipeItem key={e.id} onAction={() => deleteExpense(e.id)}><div className="flex justify-between items-center p-4"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs border" style={{ backgroundColor: colors.bg, color: colors.text, borderColor: colors.border }}>{e.cat}</div><div><div className="text-[#4A3B32] font-bold">{e.note || e.cat}</div><div className="text-xs text-[#8C7B70]">{e.date} â€¢ {e.method === 'ä¿¡ç”¨å¡' ? 'ğŸ’³' : 'ğŸ’´'}</div></div></div><div className="text-right"><div className="font-bold text-[#4A3B32]">Â¥{e.amount}</div><div className="text-[10px] text-[#8C7B70]">NT${Math.floor(e.amount * EXCHANGE_RATE)}</div></div></div></SwipeItem>); })}</div>
                </div>
            );
        };

        // --- PAGE: PACKING ---
        const Packing = ({ items, setItems }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newItem, setNewItem] = useState({ text: '', isHeader: false, addToHeader: null });

            const toggle = (id) => { setItems(items.map(i => i.id === id ? { ...i, checked: !i.checked } : i)); };
            const handleDelete = (id) => { setItems(items.filter(i => i.id !== id)); };
            const headers = items.filter(i => i.isHeader);

            const handleAddItem = () => {
                if(!newItem.text) return;
                let newItems = [...items];
                const itemToAdd = { id: Date.now(), text: newItem.text, checked: false, isHeader: newItem.isHeader };
                if(newItem.isHeader) { newItems.push(itemToAdd); } else if (newItem.addToHeader) { const headerIndex = newItems.findIndex(i => i.id === Number(newItem.addToHeader)); newItems.splice(headerIndex + 1, 0, itemToAdd); } else { newItems.push(itemToAdd); }
                setItems(newItems); setIsAdding(false); setNewItem({ text: '', isHeader: false, addToHeader: null });
            };

            const progress = items.filter(i => !i.isHeader).length > 0 ? Math.round((items.filter(i => !i.isHeader && i.checked).length / items.filter(i => !i.isHeader).length) * 100) : 0;

            return (
                <div className="p-4 pb-24">
                     <div className="flex justify-between items-center mb-6"><h1 className="text-2xl font-bold text-[#4A3B32]">è¡Œææ¸…å–®</h1><button onClick={() => setIsAdding(true)} className="text-sm bg-[#4A3B32] text-white px-3 py-1 rounded-full shadow-lg">+ æ–°å¢</button></div>
                    <div className="mb-6 bg-white p-4 rounded-2xl shadow-sm border border-[#E8D5B5]/30"><div className="flex justify-between text-xs text-[#8C7B70] mb-2 font-bold"><span>æº–å‚™é€²åº¦</span><span>{progress}%</span></div><div className="w-full bg-[#FAFAF5] rounded-full h-3 overflow-hidden"><div className="bg-[#7D8A58] h-3 rounded-full transition-all duration-500 ease-out" style={{ width: `${progress}%` }}></div></div></div>
                    <div className="space-y-2">
                        {items.map(item => (
                            item.isHeader ? 
                            <SwipeItem key={item.id} onAction={() => handleDelete(item.id)}>
                                <div className="p-2 font-bold text-[#C04829] text-sm border-t border-[#E8D5B5]/30 bg-[#FAFAF5]">{item.text}</div>
                            </SwipeItem> :
                            <SwipeItem key={item.id} onAction={() => handleDelete(item.id)}>
                                <div onClick={() => toggle(item.id)} className="flex items-center cursor-pointer p-4">
                                    <div className={`w-6 h-6 rounded-lg border flex items-center justify-center mr-3 transition-colors ${item.checked ? 'bg-[#7D8A58] border-[#7D8A58]' : 'border-[#D68C45]/50'}`}>{item.checked && <Icon name="check" size={14} className="text-white" />}</div>
                                    <span className={`font-bold transition-colors ${item.checked ? 'text-gray-300 line-through' : 'text-[#4A3B32]'}`}>{item.text}</span>
                                </div>
                            </SwipeItem>
                        ))}
                    </div>

                    {isAdding && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in modal-z">
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                                <h3 className="text-xl font-bold text-[#4A3B32] mb-4">æ–°å¢ç‰©å“</h3>
                                <div className="space-y-4">
                                    <input placeholder="ç‰©å“åç¨± / åˆ†é¡æ¨™é¡Œ" value={newItem.text} onChange={e => setNewItem({...newItem, text: e.target.value})} className="w-full p-3 border border-[#E8D5B5] rounded-xl" />
                                    <div className="flex items-center gap-2"><input type="checkbox" id="isHeader" checked={newItem.isHeader} onChange={e => setNewItem({...newItem, isHeader: e.target.checked})} className="w-5 h-5 accent-[#C04829]" /><label htmlFor="isHeader" className="text-[#4A3B32] font-bold">é€™æ˜¯ä¸€å€‹åˆ†é¡æ¨™é¡Œ</label></div>
                                    {!newItem.isHeader && headers.length > 0 && (<div><label className="text-xs font-bold text-[#8C7B70] mb-2 block">æ–°å¢åˆ°å“ªå€‹åˆ†é¡ä¸‹ï¼Ÿ</label><select className="w-full p-3 border border-[#E8D5B5] rounded-xl bg-white text-[#4A3B32]" onChange={e => setNewItem({...newItem, addToHeader: e.target.value})} value={newItem.addToHeader || ''}><option value="">(ä¸åˆ†é¡ / æœ€ä¸‹æ–¹)</option>{headers.map(h => <option key={h.id} value={h.id}>{h.text.replace('âœ… ', '').replace('ğŸ’´ ', '').replace('ğŸ“± ', '').replace('ğŸ§³ ', '').replace('ğŸ› ', '')}</option>)}</select></div>)}
                                </div>
                                <div className="flex gap-2 mt-6"><button onClick={() => setIsAdding(false)} className="flex-1 py-3 text-[#8C7B70]">å–æ¶ˆ</button><button onClick={handleAddItem} className="flex-1 bg-[#C04829] text-white rounded-xl font-bold">æ–°å¢</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
